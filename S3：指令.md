# Beanstalkd 服务端支持的指令。

[TOC]

前文提到，Beanstalkd 是由服务端和客户端组成的。其中服务端是通过接受来自客户端的指令来执行相关逻辑并管理队列。

- **客户端包含生产者和消费者**
- **服务端接收指令后执行的是管理队列相关的逻辑**

## 生产者指令

* **put**：将任务插入到队列中。
```
put <pri> <delay> <ttr> <bytes>\r\n
<data>\r\n

<pri>: 整数  < 2**32 ，表明优先级。越小优先级的任务越先执行。
<delay>:整数，将任务放入ready队列前等待的秒数，此时它位于 delayed 状态
<ttr>: time to run 允许执行该任务的秒数，从任务变为 reserved 开始计时，如果任务执行超时，那么服务端将自动释放任务。最小 ttr为 1
<bytes>: 任务实体的长度，不包含 \r\n，必须小于 max-job-size (default: 2**16)
<data>: 任务实体
```

在客户端发送 put 指令之后，会等待服务端返回结果，其结果可能如下：

    - INSERTED <id>\r\n ： 成功，其中 id 是生成的任务 id
    - BURIED <id>\r\n ：服务器为了增加队列的优先级而内存不足时返回。
    - EXPECTED_CRLF\r\n ：body后面没有带上 \r\n
    - JOB_TOO_BIG\r\n ：任务实体长度超过了 max-job-size
    - DRAINING\r\n ：表示服务器已经进入了 drain mode ，服务器再也不能接受连接，客户端应该使用另一个服务器或者断开稍后重试

- **use**：声明后面跟随的 put 指令将要使用的 tube。不存在该 tube 时服务端会自动创建。

```
use <tube>\r\n

- <tube> 管道的名称，最多 200 字节。不存在时将自动创建。
```

服务端将会返回一下结果：

    - USING <tube>\r\n

## 消费者指令

如果一个进程想要消费队列中的任务，可以使用 reserve/delete/release/bury。

- **reserve**：
```
    reserve\r\n 或者 reserve-with-timeout <seconds>\r\n

    执行后服务端将返回一个最新的任务，如果队列中没有任务，那么将会直到有任务才返回。
    一旦一个任务被取出执行，那么该客户端需要在 ttr 的时间内完成该任务，如果任务执行超时，服务端会将任务移回 ready 队列。
    执行时间和 ttr 可以通过 stats-job 指令获得。

    timeout 如果设置成0，服务端会直接返回结果或者 TIMED_OUT，一个正数则会在改数值时间内阻塞直到有新的可用任务。
```

在任务执行的 ttr 时间内，最后一秒被记为安全间隔。